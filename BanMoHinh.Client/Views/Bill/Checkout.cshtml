@using BanMoHinh.Share.Models;
@using BanMoHinh.Share.ViewModels;
@model BanMoHinh.Share.Models.Order
@{
    ViewData["Title"] = "Checkout";
    Layout = "~/Views/Shared/_Layout.cshtml";

    decimal? total = 0;
    int voucherValue = 0;
    @if (ViewData["productdetail"] != null)
    {
        var productdetail = ViewData["productdetail"] as List<ProductDetail>;
    }
@if (ViewData["pro"] != null)
    {
        var products =ViewData["pro"] as List<Product>;
    }
    // var payment = ViewData["payment"] as List<Payment>;
    // var dropDownItems = ViewBag.DropDownItems as List<SelectListItem>;

}
<div class="content">
    <div class="container">
        <div class="row">
            <form action="Checkout" method="post" enctype="multipart/form-data">

            <div class="col-lg-8 col-md-8 col-sm-8 col-xs-12">
                <div class="box checkout-form">
                    <!-- checkout - form -->
                    <div class="box-head">
                        <h2 class="head-title">Thông tin của bạn</h2>
                    </div>
                    <div class="box-body">
                        <div class="row">
                                @* <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">
                                    <div class="form-group">
                                        <label class="control-label sr-only" for="name"></label>
                                        <input name="name" type="text" class="form-control"
                                               placeholder="Họ" required>
                                    </div>
                                </div> *@
                                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                                    <div class="form-group">
                                        <label class="control-label sr-only" for="name"></label>
                                        <input id="name" name="RecipientName" type="text" class="form-control"
                                        placeholder="Tên" required>
                                    </div>
                                </div>
                                @*  <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                                    <div class="form-group">
                                        <label class="control-label sr-only" for="email">Email</label>
                                        <input id="email" name="email" type="text" class="form-control"
                                               placeholder="Email address" required>
                                    </div>
                                </div> *@
                                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                                    <div class="form-group">
                                        <label class="control-label sr-only" for="phone"></label>
                                        <input id="phone" name="RecipientPhone" type="text" class="form-control"
                                        placeholder="Phone" required>
                                    </div>
                                </div>
                                @*  <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                                    <div class="form-group">
                                        <label class="control-label sr-only"> </label>
                                        <select name="RecipientAddress" class="form-control" required>
                                            <option value="">Việt Nam</option>
                                            <option value="1">United Kingdom</option>
                                            <option value="2">United States of America</option>
                                        </select>
                                    </div>
                                </div> *@
                                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                                    <div class="form-group">
                                        <label class="control-label sr-only"></label>
                                        <input name="RecipientAddress" type="text" class="form-control"
                                        placeholder="Địa chỉ" required   >

                                    </div>
                                </div>

                                @* <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                                    <div class="form-group">
                                            <label class="control-label sr-only"> </label>
                                        @if (ViewData["user"] != null)
        {
                                            var user = ViewData["user"] as UserViewModel;


                                        <input name="UserId" type="text" class="form-control"
                                               placeholder="Địa chỉ" required value="@user.Id">

        }



                                    </div>
                                </div> *@

                                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                                    <div class="form-group">
                                        <label class="control-label sr-only"></label>
                                        @if (ViewData["payment"] != null)
                                        {
                                            var payment = ViewData["payment"] as List<Payment>;

                                            <label asp-for="PaymentId" class="control-label">PHƯƠNG THỨC THANH TOÁN</label>
                                            <select asp-for="PaymentId" class="form-control">
                                                @foreach (var type in payment)
                                                {
                                                    <option value="@type.Id">@type.PaymentName</option>
                                                }
                                            </select>
                                        }
                                    </div>
                                </div>
                                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                                    <div class="form-group">
                                        <label class="control-label sr-only"> </label>

                                        @if (ViewData["voucher"] != null)
                                        {
                                            var voucher = ViewData["voucher"] as List<Voucher>;

                                            <label asp-for="VoucherId" class="control-label">Voucher Value</label>
                                            <select asp-for="VoucherId" class="form-control" id="voucherSelect">
                                            @foreach (var type in voucher)
                                            {
                                                    voucherValue = Convert.ToInt32(type.Value);
                                                    <option value="@type.Id" data-value="@type.Value">Mã Voucher: @type.Code - Khuyến mãi: @voucherValue.ToString("n0")</option>
                                            }
                                             </select>
                                        }
                                       

                                            </div>
                                    </div>
                                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12" hidden>
                                    <div class="form-group">
                                        <label class="control-label sr-only"> </label>

                                        @if (ViewData["orderstatus"] != null)
                                        {
                                            var orderstatus = ViewData["orderstatus"] as List<OrderStatus>;

                                            <label asp-for="OrderStatusId" class="control-label"></label>
                                            <select asp-for="OrderStatusId" class="form-control">
                                                @foreach (var type in orderstatus)
                                                {
                                                    <option value="@type.Id">@type.OrderStatusName</option>
                                                }
                                            </select>
                                        }


                                    </div>
                                </div>

                                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                                    <div class="form-group">
                                        <label class="control-label sr-only" for="textarea"></label>
                                        <textarea class="form-control" id="textarea" name="Description" rows="4"
                                                  placeholder="Ghi chú"></textarea>
                                    </div>
                                    <button class="btn btn-primary " type="submit">Xác nhận thanh toán</button>
                                    <div class="checkbox alignright mt20">
                                        <label>
                                            <input type="checkbox" value="">
                                            <span>Đăng kí tài khoản?</span>
                                        </label>
                                    </div>
                                </div>
                            <!-- /.checkout-form -->
                        </div>
                    </div>
                </div>
            </div>
            <!-- product total -->
                <div class="col-lg-4 col-md-4 col-sm-4 col-xs-12">
                    <div class="box mb30">
                        <div class="box-head">
                            <h3 class="head-title">Đơn hàng của bạn</h3>
                        </div>
                        <div class="box-body">
                            <div class="table-responsive">
                                <!-- product total -->
                                <div class="pay-amount ">
                                    <table class="table mb20">
                                        <thead class="" style="border-bottom: 1px solid #e8ecf0;  text-transform: uppercase;">
                                            <tr>
                                                <th>
                                                    <span>Sản phẩm</span>
                                                </th>
                                                <th>
                                                    <span>Giá tiền</span>
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @if (ViewData["cartitem"] != null && ViewData["productdetail"] != null && ViewData["pro"] != null)
                                            {
                                                var cartItems = ViewData["cartitem"] as List<CartItem>;
                                                var productDetails = ViewData["productdetail"] as List<ProductDetailVM>;

                                                var products = ViewData["pro"] as List<Product>;

                                                foreach (var item in cartItems)
                                                {
                                                    var productDetail = productDetails.FirstOrDefault(p => p.Id == item.ProductDetail_ID);
                                                    var product = products.FirstOrDefault(p => p.Id == productDetail.ProductId);

                                                    <tr>
                                                        <td style="align-items: start">
                                                            @product.ProductName <!-- Assuming there's a property named "ProductName" in your Product class -->
                                                        </td>
                                                        <td style="align-items: center">
                                                            $@item.Price <!-- Assuming there's a property named "Price" in your CartItem class -->
                                                            X @item.Quantity
                                                        </td>
                                                    </tr>

                                                    var thanhtien = Convert.ToDecimal(item.Price) * item.Quantity;
                                                    total += thanhtien;
                                                }
                                            }
                                        </tbody>
                                        <tbody>
                                            <tr>
                                                <th>
                                                    <span>Tổng tiền sản phẩm</span>
                                                </th>
                                                <td>@string.Format("{0:N0}", total) đ</td>

                                            </tr>
                                            <tr>
                                                <th>
                                                    <span>Khuyến mãi voucher</span>
                                                </th>
                                                <td id ="voucherValueDisplay">0 đ</td>
                                            </tr>
                                            <tr>
                                                <th>
                                                    <span>Tổng thanh toán</span>
                                                </th>
                                                <td id="totalAfterDiscount">@string.Format("{0:N0}", total)</td>

                                            </tr>
                                        </tbody>

                                    </table>
                                </div>
                                <!-- /.product total -->
                            </div>
                        </div>
                    </div>
                </div>

            </form>

        </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('voucherSelect').addEventListener('change', function () {
            var selectedVoucher = this.options[this.selectedIndex];
            var voucherValue = selectedVoucher.getAttribute('data-value');
            var total = @total; // Giá trị tổng ban đầu từ server
            var newTotal = total - voucherValue; // Tính toán tổng mới sau khi trừ giảm giá
            document.getElementById('voucherValueDisplay').innerText = '-' + voucherValue + ' đ';
            document.getElementById('totalAfterDiscount').innerText = newTotal + ' đ'; // Cập nhật giá trị cho trường input ẩn
        });
    });
</script>

